{
  "config_version": "v1",
  "name": "Tokka Gateway",
  "version": "0.0.1",
  "debug": false,
  "server": {
    "port": 7805,
    "timeout": 5000,
    "metrics": {
      "enabled": true,
      "provider": "victoriametrics"
    }
  },
  "dashboard": {
    "enable": true,
    "port": 7806,
    "timeout": 5000
  },
  "features": [
    {
      "name": "ratelimit",
      "config": {
        "limit": 10,
        "window": 1
      }
    }
  ],
  "middlewares": [
    {
      "name": "recoverer",
      "path": "/tokka/middlewares/recoverer.so",
      "can_fail_on_load": false,
      "config": {
        "enabled": true
      }
    },
    {
      "name": "logger",
      "path": "/tokka/middlewares/logger.so",
      "can_fail_on_load": false,
      "config": {
        "enabled": true
      }
    },
    {
      "name": "auth",
      "path": "/tokka/middlewares/auth.so",
      "can_fail_on_load": false,
      "config": {
        "enabled": true,
        "issuer": "fake_issuer",
        "audience": "fake_audience",
        "alg": "HS256",
        "hmac_secret": "fake_hmac_secret"
      }
    }
  ],
  "routes": [
    {
      "path": "/api/users",
      "method": "GET",
      "upstreams": [
        {
          "url": "http://user-service.local/v1/users",
          "method": "GET",
          "timeout": 3000,
          "forward_query_strings": ["*"],
          "forward_headers": ["X-*"],
          "policy": {
            "allowed_statuses": [200, 404],
            "require_body": true,
            "map_status_codes": {
              "403": 404
            },
            "max_response_body_size": 4096,
            "retry": {
              "max_retries": 3,
              "retry_on_statuses": [500, 502, 503],
              "backoff_delay": "1s"
            }
          }
        },
        {
          "url": "http://profile-service.local/v1/details",
          "method": "GET",
          "forward_headers": ["X-Request-ID"]
        }
      ],
      "aggregation": {
        "strategy": "merge",
        "allow_partial_results": true
      },
      "max_parallel_upstreams": 1
    },
    {
      "path": "/api/domains",
      "method": "GET",
      "middlewares": [
        {
          "name": "logger",
          "path": "/tokka/middlewares/logger.so",
          "override": true,
          "config": {
            "enabled": false
          }
        }
      ],
      "upstreams": [
        {
          "url": "http://domain-service.local/v1/domains",
          "method": "GET",
          "timeout": 3000,
          "forward_query_strings": ["*"],
          "forward_headers": ["X-For*"]
        },
        {
          "url": "http://profile-service.local/v1/details",
          "method": "GET",
          "timeout": 2000,
          "forward_query_strings": ["id"],
          "forward_headers": ["X-For"]
        }
      ],
      "aggregation": {
        "strategy": "merge",
        "allow_partial_results": false
      },
      "max_parallel_upstreams": 3
    },
    {
      "path": "/api/domains",
      "method": "POST",
      "middlewares": [
        {
          "name": "compressor",
          "path": "/tokka/middlewares/compressor.so",
          "can_fail_on_load": false,
          "config": {
            "enabled": true,
            "alg": "gzip"
          }
        }
      ],
      "plugins": [],
      "upstreams": [
        {
          "url": "http://domain-service.local/v1/domains",
          "method": "POST",
          "timeout": 1000
        },
        {
          "url": "http://profile-service.local/v1/details",
          "method": "GET"
        }
      ],
      "aggregation": {
        "strategy": "array",
        "allow_partial_results": false
      }
    },
    {
      "path": "/api/domains",
      "method": "DELETE",
      "middlewares": [
        {
          "name": "compressor",
          "path": "/tokka/middlewares/compressor.so",
          "can_fail_on_load": false,
          "config": {
            "enabled": true,
            "alg": "deflate"
          }
        },
        {
          "name": "recoverer",
          "path": "/tokka/middlewares/recoverer.so",
          "can_fail_on_load": true,
          "override": true,
          "config": {
            "enabled": false
          }
        }
      ],
      "plugins": [],
      "upstreams": [
        {
          "url": "http://domain-service.local/v1/domains",
          "method": "DELETE",
          "timeout": 2000
        },
        {
          "url": "http://profile-service.local/v1/details",
          "method": "GET"
        }
      ],
      "aggregation": {
        "strategy": "array",
        "allow_partial_results": false
      }
    }
  ]
}
