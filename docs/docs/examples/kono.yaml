config_version: v1
name: Kono Gateway
version: "0.0.1"
debug: false

server:
  port: 7805
  timeout: 20s
  metrics:
    enabled: true
    provider: victoriametrics

dashboard:
  enabled: true
  port: 7806
  timeout: 30s

features:
  - name: ratelimit
    enabled: true
    config:
      limit: 10
      window: 1

middlewares:
  - name: recoverer
    path: /kono/middlewares/recoverer.so
    can_fail_on_load: false
    config:
      enabled: true

  - name: logger
    path: /kono/middlewares/logger.so
    can_fail_on_load: false
    config:
      enabled: true

  - name: auth
    path: /kono/middlewares/auth.so
    can_fail_on_load: false
    config:
      enabled: true
      issuer: fake_issuer
      audience: fake_audience
      alg: HS256
      hmac_secret: fake_hmac_secret

routes:
  - path: /api/users
    method: GET
    aggregation:
      strategy: merge
      allow_partial_results: true
    max_parallel_upstreams: 1
    upstreams:
      - url: http://user-service.local/v1/users
        method: GET
        timeout: 3s
        forward_query_strings: [ "*" ]
        forward_headers: [ "X-*" ]
        policy:
          allowed_statuses: [ 200, 404 ]
          require_body: true
          map_status_codes:
            403: 404
          max_response_body_size: 4096
          retry:
            max_retries: 3
            retry_on_statuses: [ 500, 502, 503 ]
            backoff_delay: 1s
          circuit_breaker:
            enabled: true
            max_failures: 5
            reset_timeout: 2s
      - url: http://profile-service.local/v1/details
        method: GET
        forward_headers: [ "X-Request-ID" ]
        policy:
          circuit_breaker:
            enabled: true
            max_failures: 5
            reset_timeout: 2s

  - path: /api/domains
    method: GET
    aggregation:
      strategy: merge
      allow_partial_results: false
    max_parallel_upstreams: 3
    middlewares:
      - name: logger
        path: /kono/middlewares/logger.so
        override: true
        config:
          enabled: false
    upstreams:
      - url: http://domain-service.local/v1/domains
        method: GET
        timeout: 3s
        forward_query_strings: [ "*" ]
        forward_headers: [ "X-For*" ]
        policy:
          circuit_breaker:
            enabled: true
            max_failures: 5
            reset_timeout: 2s
      - url: http://profile-service.local/v1/details
        method: GET
        timeout: 2s
        forward_query_strings: [ "id" ]
        forward_headers: [ "X-For" ]
        policy:
          circuit_breaker:
            enabled: true
            max_failures: 5
            reset_timeout: 2s

  - path: /api/domains
    method: POST
    aggregation:
      strategy: array
      allow_partial_results: false
    middlewares:
      - name: compressor
        path: /kono/middlewares/compressor.so
        can_fail_on_load: false
        config:
          enabled: true
          alg: gzip
    upstreams:
      - url: http://domain-service.local/v1/domains
        method: POST
        timeout: 1s
      - url: http://profile-service.local/v1/details
        method: GET

  - path: /api/domains
    method: DELETE
    aggregation:
      strategy: array
      allow_partial_results: false
    middlewares:
      - name: compressor
        path: /kono/middlewares/compressor.so
        can_fail_on_load: false
        config:
          enabled: true
          alg: deflate
      - name: recoverer
        path: /kono/middlewares/recoverer.so
        can_fail_on_load: true
        override: true
        config:
          enabled: false
    upstreams:
      - url: http://domain-service.local/v1/domains
        method: DELETE
        timeout: 2s
      - url: http://profile-service.local/v1/details
        method: GET
